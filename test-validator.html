<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PillQuest PWA - Validador de Funcionalidades</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #E8F5E8;
            color: #2E7D32;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.2);
        }
        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            background: #F9F9F9;
        }
        .test-result {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }
        .success { background: #4CAF50; color: white; }
        .error { background: #F44336; color: white; }
        .warning { background: #FF9800; color: white; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45A049;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .pill-demo {
            text-align: center;
            font-size: 3rem;
            margin: 20px 0;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíä PillQuest PWA - Validador de Funcionalidades</h1>
        <div class="pill-demo">üíä</div>
        
        <div class="test-section">
            <h3>üîß Tests de Funcionalidades Core</h3>
            <div id="core-tests"></div>
            <button onclick="runCoreTests()">Ejecutar Tests Core</button>
        </div>
        
        <div class="test-section">
            <h3>üì± Tests PWA</h3>
            <div id="pwa-tests"></div>
            <button onclick="runPWATests()">Ejecutar Tests PWA</button>
        </div>
        
        <div class="test-section">
            <h3>üóÑÔ∏è Tests IndexedDB</h3>
            <div id="db-tests"></div>
            <button onclick="runDBTests()">Ejecutar Tests DB</button>
        </div>
        
        <div class="test-section">
            <h3>üìã Log de Resultados</h3>
            <div id="test-log" class="log"></div>
            <button onclick="clearLog()">Limpiar Log</button>
        </div>
        
        <div class="test-section">
            <h3>üöÄ Acciones R√°pidas</h3>
            <button onclick="window.open('/', '_blank')">Abrir App Principal</button>
            <button onclick="testNotifications()">Test Notificaciones</button>
            <button onclick="testOffline()">Simular Offline</button>
            <button onclick="window.open('/manifest.webmanifest', '_blank')">Ver Manifest</button>
        </div>
    </div>

    <script>
        let testLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logEl = document.getElementById('test-log');
            logEl.innerHTML = testLog.join('\n');
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function clearLog() {
            testLog = [];
            updateLogDisplay();
        }
        
        function createTestResult(testName, passed, details = '') {
            const resultClass = passed ? 'success' : 'error';
            const resultText = passed ? '‚úÖ PASS' : '‚ùå FAIL';
            const detailsText = details ? ` - ${details}` : '';
            
            log(`${testName}: ${passed ? 'PASSED' : 'FAILED'}${detailsText}`, passed ? 'success' : 'error');
            
            return `
                <div>
                    ${testName}
                    <span class="test-result ${resultClass}">${resultText}</span>
                    ${details ? `<small style="display: block; color: #666; margin-top: 5px;">${details}</small>` : ''}
                </div>
            `;
        }
        
        async function runCoreTests() {
            const container = document.getElementById('core-tests');
            container.innerHTML = '<p>Ejecutando tests...</p>';
            
            let results = '';
            
            // Test 1: JavaScript ES6+ Features
            try {
                const testClass = class TestClass { 
                    async testMethod() { return Promise.resolve(true); }
                };
                const instance = new testClass();
                await instance.testMethod();
                results += createTestResult('JavaScript ES6+ Support', true, 'Classes, async/await funcionando');
            } catch (e) {
                results += createTestResult('JavaScript ES6+ Support', false, e.message);
            }
            
            // Test 2: LocalStorage API
            try {
                localStorage.setItem('test', 'pillquest');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                results += createTestResult('LocalStorage API', value === 'pillquest', 'Persistencia local disponible');
            } catch (e) {
                results += createTestResult('LocalStorage API', false, e.message);
            }
            
            // Test 3: IndexedDB Support
            try {
                const supported = 'indexedDB' in window;
                results += createTestResult('IndexedDB Support', supported, supported ? 'Base de datos nativa disponible' : 'No soportado');
            } catch (e) {
                results += createTestResult('IndexedDB Support', false, e.message);
            }
            
            // Test 4: Service Worker Support
            try {
                const supported = 'serviceWorker' in navigator;
                results += createTestResult('Service Worker Support', supported, supported ? 'PWA offline disponible' : 'No soportado');
            } catch (e) {
                results += createTestResult('Service Worker Support', false, e.message);
            }
            
            // Test 5: Fetch API
            try {
                const supported = 'fetch' in window;
                results += createTestResult('Fetch API Support', supported, supported ? 'Requests modernos disponibles' : 'No soportado');
            } catch (e) {
                results += createTestResult('Fetch API Support', false, e.message);
            }
            
            container.innerHTML = results;
        }
        
        async function runPWATests() {
            const container = document.getElementById('pwa-tests');
            container.innerHTML = '<p>Ejecutando tests PWA...</p>';
            
            let results = '';
            
            // Test 1: Manifest File
            try {
                const response = await fetch('/manifest.webmanifest');
                const manifest = await response.json();
                const hasRequiredFields = manifest.name && manifest.start_url && manifest.icons;
                results += createTestResult('Manifest File', hasRequiredFields, `${manifest.name} - ${manifest.icons.length} iconos`);
            } catch (e) {
                results += createTestResult('Manifest File', false, e.message);
            }
            
            // Test 2: HTTPS Context
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            results += createTestResult('Secure Context', isSecure, isSecure ? 'PWA instalable' : 'Requiere HTTPS');
            
            // Test 3: Responsive Viewport
            const hasViewport = document.querySelector('meta[name="viewport"]');
            results += createTestResult('Responsive Viewport', !!hasViewport, hasViewport ? hasViewport.getAttribute('content') : 'No encontrado');
            
            // Test 4: Theme Color
            const hasTheme = document.querySelector('meta[name="theme-color"]');
            results += createTestResult('Theme Color', !!hasTheme, hasTheme ? hasTheme.getAttribute('content') : 'No definido');
            
            // Test 5: Icons Availability
            try {
                const iconResponse = await fetch('/icons/icon-192.svg');
                results += createTestResult('App Icons', iconResponse.ok, iconResponse.ok ? 'Iconos disponibles' : 'Iconos no encontrados');
            } catch (e) {
                results += createTestResult('App Icons', false, e.message);
            }
            
            container.innerHTML = results;
        }
        
        async function runDBTests() {
            const container = document.getElementById('db-tests');
            container.innerHTML = '<p>Ejecutando tests de base de datos...</p>';
            
            let results = '';
            
            // Test 1: IndexedDB Creation
            try {
                const request = indexedDB.open('PillQuestTestDB', 1);
                
                await new Promise((resolve, reject) => {
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        request.result.close();
                        indexedDB.deleteDatabase('PillQuestTestDB');
                        resolve();
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        db.createObjectStore('test', { keyPath: 'id', autoIncrement: true });
                    };
                });
                
                results += createTestResult('IndexedDB Creation', true, 'Base de datos creada correctamente');
            } catch (e) {
                results += createTestResult('IndexedDB Creation', false, e.message);
            }
            
            // Test 2: Date/Time Handling
            try {
                const now = new Date();
                const iso = now.toISOString();
                const parsed = new Date(iso);
                const isValid = !isNaN(parsed.getTime());
                results += createTestResult('Date Handling', isValid, isValid ? 'Fechas ISO funcionando' : 'Error en fechas');
            } catch (e) {
                results += createTestResult('Date Handling', false, e.message);
            }
            
            // Test 3: JSON Serialization
            try {
                const testData = { id: 1, name: 'Test User', treatments: [{ id: 1, name: 'Aspirin' }] };
                const json = JSON.stringify(testData);
                const parsed = JSON.parse(json);
                const isValid = parsed.id === testData.id && parsed.treatments[0].name === 'Aspirin';
                results += createTestResult('JSON Serialization', isValid, isValid ? 'Serializaci√≥n correcta' : 'Error en JSON');
            } catch (e) {
                results += createTestResult('JSON Serialization', false, e.message);
            }
            
            container.innerHTML = results;
        }
        
        async function testNotifications() {
            try {
                if (!('Notification' in window)) {
                    log('Notificaciones no soportadas', 'error');
                    return;
                }
                
                const permission = await Notification.requestPermission();
                log(`Permiso de notificaciones: ${permission}`, permission === 'granted' ? 'success' : 'warning');
                
                if (permission === 'granted') {
                    new Notification('PillQuest Test', {
                        body: '¬°Test de notificaciones exitoso!',
                        icon: '/icons/icon-96.svg',
                        tag: 'test'
                    });
                    log('Notificaci√≥n de test enviada', 'success');
                }
            } catch (e) {
                log('Error en test de notificaciones: ' + e.message, 'error');
            }
        }
        
        function testOffline() {
            log('Simulando modo offline...', 'info');
            log('Para probar offline real: DevTools > Network > Offline', 'info');
            
            // Intentar hacer un request para ver el comportamiento
            fetch('/test-offline-endpoint')
                .then(() => log('Request exitoso (online)', 'success'))
                .catch(() => log('Request fall√≥ (offline o endpoint no existe)', 'warning'));
        }
        
        // Auto-run core tests on load
        window.addEventListener('load', () => {
            log('Validador de PillQuest PWA iniciado', 'info');
            log('Ejecuta los tests para verificar funcionalidades', 'info');
        });
    </script>
</body>
</html>